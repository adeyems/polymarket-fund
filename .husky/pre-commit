#!/bin/sh

echo "========================================"
echo "  Running Pre-Commit Checks"
echo "========================================"

# 1. Check Python syntax on changed files
echo ""
echo "[1/2] Checking Python syntax..."
SYNTAX_ERROR=0
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$CHANGED_FILES" ]; then
    for file in $CHANGED_FILES; do
        python3 -m py_compile "$file" 2>&1
        if [ $? -ne 0 ]; then
            echo "  ✗ Syntax error in $file"
            SYNTAX_ERROR=1
        else
            echo "  ✓ $file"
        fi
    done
else
    echo "  No Python files changed"
fi

if [ $SYNTAX_ERROR -ne 0 ]; then
    echo ""
    echo "Fix syntax errors before committing."
    exit 1
fi

# 2. Run unit tests (fast)
echo ""
echo "[2/2] Running unit tests..."
pytest tests/unit/ -x --tb=line -q 2>&1

if [ $? -ne 0 ]; then
    echo ""
    echo "========================================"
    echo "  COMMIT BLOCKED: Tests Failed"
    echo "========================================"
    echo ""
    echo "Fix failing tests before committing."
    echo "Run: pytest tests/unit/ -v"
    exit 1
fi

echo ""
echo "========================================"
echo "  All Checks Passed ✓"
echo "========================================"

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Hive Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --green: #3fb950;
            --red: #f85149;
            --yellow: #d29922;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        h1 { font-size: 22px; font-weight: 600; }

        .status-badge {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 12px; background: var(--bg-card);
            border-radius: 20px; font-size: 13px;
        }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--green);
        }

        .tabs {
            display: flex; gap: 4px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px; margin-bottom: 24px;
        }
        .tab {
            padding: 8px 16px; background: transparent; border: none;
            color: var(--text-muted); cursor: pointer; border-radius: 6px;
            font-size: 14px; transition: all 0.2s;
        }
        .tab:hover { color: var(--text); background: var(--bg-card); }
        .tab.active { color: var(--accent); background: rgba(88,166,255,0.1); }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        .grid-2 { grid-template-columns: 1fr 1fr; }

        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 8px; padding: 20px;
        }
        .card-title {
            font-size: 13px; font-weight: 500; color: var(--text-muted);
            text-transform: uppercase; margin-bottom: 12px;
        }

        .metric-value { font-size: 28px; font-weight: 700; }
        .metric-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

        .positive { color: var(--green); }
        .negative { color: var(--red); }

        .section-title {
            font-size: 16px; font-weight: 600; margin-bottom: 16px;
            padding-bottom: 8px; border-bottom: 1px solid var(--border);
        }

        table {
            width: 100%; border-collapse: collapse;
        }
        th, td {
            padding: 10px 12px; text-align: left;
            border-bottom: 1px solid var(--border); font-size: 13px;
        }
        th {
            font-size: 11px; color: var(--text-muted);
            text-transform: uppercase; font-weight: 500;
        }
        tr:hover { background: rgba(88,166,255,0.05); }

        .badge {
            padding: 3px 8px; border-radius: 4px;
            font-size: 11px; font-weight: 500;
        }
        .badge-running { background: rgba(63,185,80,0.2); color: var(--green); }
        .badge-paused { background: rgba(210,153,34,0.2); color: var(--yellow); }
        .badge-stopped { background: rgba(248,81,73,0.2); color: var(--red); }
        .badge-win { background: rgba(63,185,80,0.15); color: var(--green); }
        .badge-loss { background: rgba(248,81,73,0.15); color: var(--red); }
        .badge-pending { background: rgba(210,153,34,0.15); color: var(--yellow); }

        .chart-container { position: relative; height: 280px; margin-top: 12px; }

        .hidden { display: none; }

        .warning-box {
            background: rgba(210,153,34,0.1); border: 1px solid rgba(210,153,34,0.3);
            border-radius: 6px; padding: 12px; margin-bottom: 8px;
            font-size: 13px; color: var(--yellow);
        }
        .warning-box.p0 {
            background: rgba(248,81,73,0.1); border-color: rgba(248,81,73,0.3);
            color: var(--red);
        }

        .live-label {
            display: inline-block; padding: 2px 6px; border-radius: 3px;
            font-size: 10px; font-weight: 600; text-transform: uppercase;
            margin-left: 8px;
        }
        .live-label-paper { background: rgba(88,166,255,0.2); color: var(--accent); }
        .live-label-live { background: rgba(63,185,80,0.2); color: var(--green); }

        .empty-state {
            text-align: center; padding: 40px; color: var(--text-muted);
            font-size: 14px;
        }

        .scroll-table { max-height: 500px; overflow-y: auto; }

        .info-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 0; font-size: 13px;
        }
        .info-label { color: var(--text-muted); }
        .info-value { font-weight: 500; }

        .divider { border-top: 1px solid var(--border); margin: 8px 0; }

        footer {
            text-align: center; padding: 24px 0; color: var(--text-muted);
            font-size: 11px; border-top: 1px solid var(--border); margin-top: 32px;
        }

        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Sovereign Hive Dashboard</h1>
            <div class="status-badge">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Connecting...</span>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="positions">Positions</button>
            <button class="tab" data-tab="trades">Trade History</button>
            <button class="tab" data-tab="strategies">Strategies</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="tab-overview">
            <!-- On-Chain Verified Wallet -->
            <h3 class="section-title">
                On-Chain Wallet
                <span class="live-label live-label-live">VERIFIED</span>
                <span id="onchainFreshness" style="font-size:11px;color:var(--text-muted);margin-left:12px;font-weight:400">Loading...</span>
                <button onclick="refreshOnchain()" style="margin-left:8px;padding:2px 10px;font-size:11px;background:var(--bg-card);border:1px solid var(--border);color:var(--accent);border-radius:4px;cursor:pointer">Refresh</button>
            </h3>
            <div class="grid">
                <div class="card">
                    <div class="card-title">Total Value (On-Chain Verified)</div>
                    <div class="metric-value" id="liveTotal">--</div>
                    <div class="metric-sub" id="liveBreakdown">--</div>
                    <div class="metric-sub" style="margin-top:6px">
                        <a id="polygonscanLink" href="#" target="_blank" style="color:var(--accent);text-decoration:none;font-size:11px">View on Polygonscan</a>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">P&L (vs $85 invested)</div>
                    <div class="metric-value" id="livePnl">--</div>
                    <div class="metric-sub" id="liveRoi">--</div>
                    <div class="metric-sub" id="liveStarting">--</div>
                </div>
                <div class="card">
                    <div class="card-title">Balances (On-Chain)</div>
                    <div id="liveBalances">
                        <div class="info-row">
                            <span class="info-label">USDC.e (wallet)</span>
                            <span class="info-value" id="liveUsdc">--</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Positions (mark-to-market)</span>
                            <span class="info-value" id="liveSharesValue">--</span>
                        </div>
                        <div class="divider"></div>
                        <div class="info-row">
                            <span class="info-label">POL (gas)</span>
                            <span class="info-value" id="livePol">--</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Positions</div>
                    <div class="metric-value" id="livePositionCount">--</div>
                    <div class="metric-sub" id="livePositionSummary">--</div>
                </div>
            </div>

            <!-- Live Positions (On-Chain + CLOB) -->
            <div id="onchainPositionsSection" style="margin-bottom:24px">
                <div class="card">
                    <div class="card-title">Open Positions (On-Chain Verified)</div>
                    <div id="onchainDeadAlert" class="hidden" style="margin-bottom:12px">
                        <div class="warning-box p0">ALERT: One or more positions have a DEAD orderbook (spread &gt;50%)</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Market</th>
                                <th>State</th>
                                <th>Entry</th>
                                <th>Bid Now</th>
                                <th>Spread</th>
                                <th>Shares (on-chain)</th>
                                <th>Value</th>
                                <th>P&L</th>
                                <th>Hold</th>
                                <th>Health</th>
                            </tr>
                        </thead>
                        <tbody id="onchainPositionsBody"></tbody>
                    </table>
                    <div id="onchainPositionsEmpty" class="empty-state hidden">No open positions</div>
                </div>
            </div>

            <h3 class="section-title">Paper Trading <span class="live-label live-label-paper">PAPER</span></h3>
            <div class="grid">
                <div class="card">
                    <div class="card-title">Portfolio Value</div>
                    <div class="metric-value" id="paperBalance">--</div>
                    <div class="metric-sub">Started $1,000</div>
                </div>
                <div class="card">
                    <div class="card-title">Total P&L</div>
                    <div class="metric-value" id="paperPnl">--</div>
                    <div class="metric-sub" id="paperRoi">--</div>
                </div>
                <div class="card">
                    <div class="card-title">Win Rate</div>
                    <div class="metric-value" id="paperWinRate">--</div>
                    <div class="metric-sub" id="paperTrades">--</div>
                </div>
                <div class="card">
                    <div class="card-title">Open Positions</div>
                    <div class="metric-value" id="paperPositions">--</div>
                    <div class="metric-sub" id="paperDrawdown">--</div>
                </div>
            </div>

            <div id="warningsSection" class="hidden">
                <h3 class="section-title">Active Warnings</h3>
                <div id="warningsList"></div>
            </div>
        </div>

        <!-- POSITIONS TAB -->
        <div id="tab-positions" class="hidden">
            <!-- Paper Positions -->
            <div class="card">
                <div class="card-title">Paper Positions (<span id="posCount">0</span>) <span class="live-label live-label-paper">PAPER</span></div>
                <div class="scroll-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Market</th>
                                <th>Strategy</th>
                                <th>Side</th>
                                <th>Entry</th>
                                <th>Shares</th>
                                <th>Cost</th>
                                <th>Sector</th>
                            </tr>
                        </thead>
                        <tbody id="positionsBody"></tbody>
                    </table>
                </div>
                <div id="positionsEmpty" class="empty-state hidden">No open positions</div>
            </div>
        </div>

        <!-- TRADES TAB -->
        <div id="tab-trades" class="hidden">
            <!-- Live Trades -->
            <div class="card" style="margin-bottom:16px">
                <div class="card-title">Live Trades (<span id="liveTradeCount">0</span>) <span class="live-label live-label-live">LIVE</span></div>
                <div class="scroll-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Market</th>
                                <th>Strategy</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>Shares</th>
                                <th>P&L</th>
                                <th>Reason</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="liveTradesBody"></tbody>
                    </table>
                </div>
                <div id="liveTradesEmpty" class="empty-state hidden">No live trades yet</div>
            </div>

            <!-- Paper Trades -->
            <div class="card">
                <div class="card-title">Paper Trades (<span id="tradeCount">0</span> / <span id="totalTrades">0</span>) <span class="live-label live-label-paper">PAPER</span></div>
                <div class="scroll-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Market</th>
                                <th>Strategy</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>Shares</th>
                                <th>P&L</th>
                                <th>Reason</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="tradesBody"></tbody>
                    </table>
                </div>
                <div id="tradesEmpty" class="empty-state hidden">No closed trades yet</div>
            </div>
        </div>

        <!-- STRATEGIES TAB -->
        <div id="tab-strategies" class="hidden">
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-title">Strategy P&L Comparison</div>
                    <div class="chart-container">
                        <canvas id="pnlChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-title">Win Rate by Strategy</div>
                    <div class="chart-container">
                        <canvas id="winRateChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="card" style="margin-top:16px">
                <div class="card-title">Paper Strategy Details</div>
                <table>
                    <thead>
                        <tr>
                            <th>Strategy</th>
                            <th>Status</th>
                            <th>Balance</th>
                            <th>P&L</th>
                            <th>Win Rate</th>
                            <th>Trades</th>
                            <th>Open</th>
                        </tr>
                    </thead>
                    <tbody id="strategyBody"></tbody>
                </table>
            </div>
        </div>

        <footer>
            Sovereign Hive Dashboard &mdash; Read-Only &mdash; localhost:8050
        </footer>
    </div>

    <script>
        // ── State ──────────────────────────────────────────────────
        let pnlChart = null, winRateChart = null;

        // ── Tab Navigation ─────────────────────────────────────────
        document.querySelectorAll('.tab').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('[id^="tab-"]').forEach(p => p.classList.add('hidden'));
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.remove('hidden');
            });
        });

        // ── Helpers ────────────────────────────────────────────────
        const $ = id => document.getElementById(id);
        const fmt = (v, d=2) => { const n = Number(v); return v != null && !isNaN(n) ? '$' + n.toFixed(d) : '--'; };
        const pnlClass = v => v >= 0 ? 'positive' : 'negative';
        const pnlSign = v => v >= 0 ? '+' : '';

        async function api(path) {
            const res = await fetch(path, { credentials: 'same-origin' });
            if (res.status === 401) {
                document.body.innerHTML = '<h2 style="font-family:sans-serif;color:#f85149;text-align:center;padding:60px">Session expired. Restart dashboard for a new token.</h2>';
                throw new Error('unauthorized');
            }
            if (!res.ok) return null;
            return res.json();
        }

        function timeAgo(isoStr) {
            if (!isoStr) return 'unknown';
            const d = new Date(isoStr);
            const now = new Date();
            const mins = Math.round((now - d) / 60000);
            if (mins < 1) return 'just now';
            if (mins < 60) return mins + 'm ago';
            const hrs = Math.round(mins / 60);
            if (hrs < 24) return hrs + 'h ago';
            return Math.round(hrs / 24) + 'd ago';
        }

        // ── Paper Data ─────────────────────────────────────────────
        async function loadPaper() {
            const data = await api('/api/paper/summary');
            if (!data) return;

            $('paperBalance').textContent = fmt(data.balance);
            const pnl = data.total_pnl;
            $('paperPnl').textContent = pnlSign(pnl) + fmt(pnl);
            $('paperPnl').className = 'metric-value ' + pnlClass(pnl);
            $('paperRoi').textContent = pnlSign(data.roi_pct) + data.roi_pct.toFixed(1) + '% ROI';
            $('paperWinRate').textContent = data.win_rate + '%';
            $('paperTrades').textContent = data.total_trades + ' trades';
            $('paperPositions').textContent = data.open_positions;
            $('paperDrawdown').textContent = 'Max DD: ' + data.max_drawdown + '%';

            if (data.strategies) updateStrategyCharts(data.strategies);
        }

        // ── On-Chain Verified Data ─────────────────────────────────
        async function loadOnchain() {
            const data = await api('/api/onchain');
            if (!data) {
                $('onchainFreshness').textContent = 'Waiting for first fetch...';
                $('onchainFreshness').style.color = 'var(--yellow)';
                return;
            }

            const b = data.balances || {};
            const pnl = data.pnl || {};
            const positions = data.positions || {};

            // Freshness indicator
            const fetchedAt = data.fetched_at;
            const freshness = timeAgo(fetchedAt);
            const minsAgo = fetchedAt ? Math.round((Date.now() - new Date(fetchedAt)) / 60000) : 999;
            $('onchainFreshness').textContent = 'Last verified: ' + freshness;
            $('onchainFreshness').style.color = minsAgo < 3 ? 'var(--green)' : minsAgo < 10 ? 'var(--yellow)' : 'var(--red)';

            // Polygonscan link
            $('polygonscanLink').href = data.polygonscan_url || '#';

            // Total value
            $('liveTotal').textContent = fmt(b.total);
            const parts = [];
            if (b.usdc) parts.push(fmt(b.usdc) + ' USDC');
            if (b.positions_mark_value) parts.push(fmt(b.positions_mark_value) + ' positions');
            $('liveBreakdown').textContent = parts.join(' + ') || 'No data';

            // Balances
            $('liveUsdc').textContent = fmt(b.usdc);
            $('liveSharesValue').textContent = fmt(b.positions_mark_value);
            $('livePol').textContent = b.pol ? b.pol.toFixed(2) + ' POL' : '0 POL';

            // P&L
            const pnlUsd = pnl.pnl_usd || 0;
            const pnlPct = pnl.pnl_pct || 0;
            $('livePnl').textContent = pnlSign(pnlUsd) + fmt(pnlUsd);
            $('livePnl').className = 'metric-value ' + pnlClass(pnlUsd);
            $('liveRoi').textContent = pnlSign(pnlPct) + pnlPct.toFixed(1) + '% ROI';
            $('liveRoi').className = 'metric-sub ' + pnlClass(pnlPct);
            $('liveStarting').textContent = 'Invested: ' + fmt(pnl.total_invested);

            // Position count
            const posCount = Object.keys(positions).length;
            $('livePositionCount').textContent = posCount;
            let healthySummary = [];
            let hasDead = false;
            for (const p of Object.values(positions)) {
                if (p.health === 'dead') hasDead = true;
            }
            $('livePositionSummary').textContent = hasDead ? 'WARNING: Dead orderbook detected' : (posCount ? 'Active positions' : 'No open positions');
            $('livePositionSummary').style.color = hasDead ? 'var(--red)' : 'var(--text-muted)';

            // Positions table
            const posArr = Object.values(positions);
            if (posArr.length) {
                $('onchainPositionsEmpty').classList.add('hidden');
                if (hasDead) $('onchainDeadAlert').classList.remove('hidden');
                else $('onchainDeadAlert').classList.add('hidden');

                $('onchainPositionsBody').innerHTML = posArr.map(p => {
                    const rowStyle = p.health === 'dead' ? 'background:rgba(248,81,73,0.08);' :
                                     p.health === 'warning' ? 'background:rgba(210,153,34,0.08);' : '';
                    const healthClass = p.health === 'dead' ? 'badge-stopped' :
                                        p.health === 'warning' ? 'badge-paused' :
                                        p.health === 'caution' ? 'badge-paused' : 'badge-running';
                    const spreadStyle = p.spread_pct > 50 ? 'color:var(--red);font-weight:700' :
                                        p.spread_pct > 20 ? 'color:var(--yellow)' : '';
                    const holdStr = p.hold_hours >= 24 ? (p.hold_hours / 24).toFixed(1) + 'd' :
                                    p.hold_hours >= 1 ? p.hold_hours.toFixed(1) + 'h' :
                                    Math.round(p.hold_hours * 60) + 'm';
                    const sharesMatch = p.shares_match ? '' : ' <span style="color:var(--red)" title="On-chain doesn\'t match reported">(!)</span>';
                    const resolvedTag = p.market_resolved ? '<span class="badge badge-win" style="margin-left:4px">RESOLVED</span>' : '';
                    return '<tr style="' + rowStyle + '">' +
                        '<td>' + esc(p.question) + resolvedTag + '</td>' +
                        '<td><span class="badge badge-pending">' + esc(p.live_state) + '</span></td>' +
                        '<td>' + fmt(p.entry_price, 3) + '</td>' +
                        '<td>' + (p.current_bid > 0 ? fmt(p.current_bid, 3) : '--') + '</td>' +
                        '<td style="' + spreadStyle + '">' + (p.spread_pct || 0).toFixed(0) + '%</td>' +
                        '<td>' + (p.shares_onchain || 0).toFixed(2) + sharesMatch + '</td>' +
                        '<td>' + fmt(p.mark_value) + '</td>' +
                        '<td class="' + pnlClass(p.unrealized_pnl) + '">' + pnlSign(p.unrealized_pnl) + fmt(p.unrealized_pnl) + ' (' + (p.unrealized_pnl_pct || 0).toFixed(1) + '%)</td>' +
                        '<td>' + holdStr + '</td>' +
                        '<td><span class="badge ' + healthClass + '">' + esc(p.health) + '</span></td>' +
                        '</tr>';
                }).join('');
            } else {
                $('onchainPositionsEmpty').classList.remove('hidden');
                $('onchainPositionsBody').innerHTML = '';
                $('onchainDeadAlert').classList.add('hidden');
            }

            // Warnings
            const warnings = [];
            for (const p of posArr) {
                if (p.health === 'dead') warnings.push('P0: ' + p.question + ' — DEAD orderbook (spread ' + p.spread_pct + '%)');
                if (!p.shares_match) warnings.push('P1: ' + p.question + ' — on-chain shares (' + (p.shares_onchain||0).toFixed(2) + ') != reported (' + (p.shares_reported||0).toFixed(2) + ')');
            }
            if (warnings.length) {
                $('warningsSection').classList.remove('hidden');
                $('warningsList').innerHTML = warnings.map(w => {
                    const isP0 = w.startsWith('P0');
                    return '<div class="warning-box' + (isP0 ? ' p0' : '') + '">' + esc(w) + '</div>';
                }).join('');
            } else {
                $('warningsSection').classList.add('hidden');
            }
        }

        async function refreshOnchain() {
            $('onchainFreshness').textContent = 'Refreshing...';
            $('onchainFreshness').style.color = 'var(--accent)';
            try {
                await api('/api/onchain/refresh');
                await loadOnchain();
            } catch(e) {
                $('onchainFreshness').textContent = 'Refresh failed';
                $('onchainFreshness').style.color = 'var(--red)';
            }
        }

        // Keep old loadLive for backward compat with paper strategies
        async function loadLive() {
            const data = await api('/api/live/summary');
            if (!data) return;
            // Paper strategies from monitor_state
            const ps = data.paper_strategies || {};
            if (Object.keys(ps).length) updateStrategyTable(ps);
        }

        // ── Live Trades ──────────────────────────────────────────
        async function loadLiveTrades() {
            const data = await api('/api/live/trades');
            if (!data) {
                $('liveTradesEmpty').classList.remove('hidden');
                return;
            }

            $('liveTradeCount').textContent = data.count || 0;
            if (!data.trades || !data.trades.length) {
                $('liveTradesEmpty').classList.remove('hidden');
                return;
            }
            $('liveTradesEmpty').classList.add('hidden');
            $('liveTradesBody').innerHTML = data.trades.map(t => {
                const cls = t.pnl >= 0 ? 'badge-win' : 'badge-loss';
                return '<tr>' +
                    '<td>' + esc(t.question) + '</td>' +
                    '<td>' + esc(t.strategy) + '</td>' +
                    '<td>' + fmt(t.entry_price, 3) + '</td>' +
                    '<td>' + fmt(t.exit_price, 3) + '</td>' +
                    '<td>' + t.shares.toFixed(2) + '</td>' +
                    '<td><span class="badge ' + cls + '">' + pnlSign(t.pnl) + fmt(t.pnl) + ' (' + pnlSign(t.pnl_pct) + t.pnl_pct.toFixed(1) + '%)</span></td>' +
                    '<td>' + esc(t.exit_reason || '-') + '</td>' +
                    '<td style="font-size:11px">' + (t.exit_time ? t.exit_time.split('T')[0] + ' ' + t.exit_time.split('T')[1].split('.')[0].slice(0,5) : '-') + '</td>' +
                    '</tr>';
            }).join('');
        }

        // ── Paper Positions ──────────────────────────────────────
        async function loadPositions() {
            const data = await api('/api/paper/positions');
            if (!data) return;

            $('posCount').textContent = data.count;
            if (!data.positions.length) {
                $('positionsEmpty').classList.remove('hidden');
                return;
            }
            $('positionsEmpty').classList.add('hidden');
            $('positionsBody').innerHTML = data.positions.map(p =>
                '<tr>' +
                '<td>' + esc(p.question) + '</td>' +
                '<td>' + esc(p.strategy) + '</td>' +
                '<td>' + esc(p.side) + '</td>' +
                '<td>' + fmt(p.entry_price, 4) + '</td>' +
                '<td>' + p.shares.toFixed(2) + '</td>' +
                '<td>' + fmt(p.cost_basis) + '</td>' +
                '<td>' + esc(p.sector || '-') + '</td>' +
                '</tr>'
            ).join('');
        }

        // ── Paper Trades ─────────────────────────────────────────
        async function loadTrades() {
            const data = await api('/api/paper/trades?limit=100');
            if (!data) return;

            $('tradeCount').textContent = data.count;
            $('totalTrades').textContent = data.total;
            if (!data.trades.length) {
                $('tradesEmpty').classList.remove('hidden');
                return;
            }
            $('tradesEmpty').classList.add('hidden');
            $('tradesBody').innerHTML = data.trades.map(t => {
                const cls = t.pnl >= 0 ? 'badge-win' : 'badge-loss';
                return '<tr>' +
                    '<td>' + esc(t.question) + '</td>' +
                    '<td>' + esc(t.strategy) + '</td>' +
                    '<td>' + fmt(t.entry_price, 4) + '</td>' +
                    '<td>' + fmt(t.exit_price, 4) + '</td>' +
                    '<td>' + t.shares.toFixed(2) + '</td>' +
                    '<td><span class="badge ' + cls + '">' + pnlSign(t.pnl) + fmt(t.pnl) + ' (' + pnlSign(t.pnl_pct) + t.pnl_pct.toFixed(1) + '%)</span></td>' +
                    '<td>' + esc(t.exit_reason || '-') + '</td>' +
                    '<td style="font-size:11px">' + (t.exit_time ? t.exit_time.split('T')[0] : '-') + '</td>' +
                    '</tr>';
            }).join('');
        }

        // ── Strategy Charts ────────────────────────────────────────
        function updateStrategyCharts(strategies) {
            const names = Object.keys(strategies);
            const pnls = names.map(n => strategies[n].pnl);
            const wrs = names.map(n => strategies[n].win_rate);

            const pnlColors = pnls.map(v => v >= 0 ? 'rgba(63,185,80,0.7)' : 'rgba(248,81,73,0.7)');

            if (pnlChart) pnlChart.destroy();
            pnlChart = new Chart($('pnlChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{ label: 'P&L ($)', data: pnls, backgroundColor: pnlColors }]
                },
                options: chartOpts('$')
            });

            if (winRateChart) winRateChart.destroy();
            winRateChart = new Chart($('winRateChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{ label: 'Win Rate (%)', data: wrs, backgroundColor: 'rgba(88,166,255,0.6)' }]
                },
                options: chartOpts('%')
            });
        }

        function chartOpts(suffix) {
            return {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#8b949e', font: { size: 10 } } },
                    y: { grid: { color: '#30363d' }, ticks: {
                        color: '#8b949e',
                        callback: v => suffix === '$' ? '$' + v : v + '%'
                    }}
                }
            };
        }

        function updateStrategyTable(strategies) {
            $('strategyBody').innerHTML = Object.entries(strategies).map(([name, s]) => {
                const statusCls = s.status === 'running' ? 'running' : s.status === 'paused' ? 'paused' : 'stopped';
                const pnl = s.pnl || 0;
                return '<tr>' +
                    '<td><strong>' + esc(name) + '</strong></td>' +
                    '<td><span class="badge badge-' + statusCls + '">' + esc(s.status) + '</span></td>' +
                    '<td>' + fmt(s.balance) + '</td>' +
                    '<td class="' + pnlClass(pnl) + '">' + pnlSign(pnl) + fmt(pnl) + '</td>' +
                    '<td>' + (s.win_rate || 0) + '%</td>' +
                    '<td>' + (s.trades || 0) + '</td>' +
                    '<td>' + (s.open_positions || 0) + '</td>' +
                    '</tr>';
            }).join('');
        }

        // ── Escape HTML ────────────────────────────────────────────
        function esc(s) {
            const d = document.createElement('div');
            d.textContent = s || '';
            return d.innerHTML;
        }

        // ── Health Check ───────────────────────────────────────────
        async function checkHealth() {
            try {
                const res = await fetch('/api/health');
                if (res.ok) {
                    $('statusDot').style.background = 'var(--green)';
                    $('statusText').textContent = 'Connected';
                } else throw 0;
            } catch {
                $('statusDot').style.background = 'var(--red)';
                $('statusText').textContent = 'Offline';
            }
        }

        // ── Initialize ─────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            loadOnchain();
            loadPaper();
            loadLive();
            loadPositions();
            loadTrades();
            loadLiveTrades();

            // Poll intervals
            setInterval(loadOnchain, 120000);  // On-chain: every 2min (matches backend refresh)
            setInterval(loadPaper, 10000);
            setInterval(loadPositions, 10000);
            setInterval(loadTrades, 30000);
            setInterval(loadLive, 60000);
            setInterval(loadLiveTrades, 60000);
            setInterval(checkHealth, 30000);
        });
    </script>
</body>
</html>
